{
  "name": "SEO Post Editor - Fix Low Score Posts (Optimized)",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "wordpressUrl",
              "value": "https://tax4us.co.il",
              "type": "string"
            },
            {
              "id": "2",
              "name": "slackChannel",
              "value": "C09BZAFD5U7",
              "type": "string"
            },
            {
              "id": "3",
              "name": "scoreThreshold",
              "value": 80,
              "type": "number"
            },
            {
              "id": "4",
              "name": "targetScore",
              "value": 95,
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "57be10d8-1e8f-4d12-aa3f-edf872eb8f24",
      "name": "Configuration",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -9968,
        5216
      ]
    },
    {
      "parameters": {
        "url": "={{ $('Configuration').first().json.wordpressUrl }}/wp-json/wp/v2/posts",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "wordpressApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "per_page",
              "value": "100"
            },
            {
              "name": "status",
              "value": "publish"
            },
            {
              "name": "orderby",
              "value": "date"
            },
            {
              "name": "order",
              "value": "desc"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "c0e2181d-7b96-488b-a093-f8516ee274e8",
      "name": "HTTP: Fetch All Published Posts",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -9744,
        5216
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "credentials": {
        "wordpressApi": {
          "id": "S5Sr1ruBZOv5jSn5",
          "name": "Wordpress account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-post",
              "leftValue": "={{ (($json.topicLowestScore ?? $json.posts?.topicLowestScore ?? 0) < $('Configuration').first().json.scoreThreshold) }}",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "b9ce6ab2-d611-402e-8cfd-fe18e60087c5",
              "leftValue": "={{ $json.id ?? $json.posts?.id }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "b4a647c7-98e9-43fb-b9a1-81e24e04bf96",
              "leftValue": "={{ (($json.seoScore ?? $json.posts?.seoScore ?? 0) < $('Configuration').first().json.scoreThreshold) }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "aebb9e00-3301-4e76-9e81-b820f1b3c6ed",
      "name": "Posts Need Fixing?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -8400,
        5216
      ]
    },
    {
      "parameters": {
        "jsCode": "// Analyze SEO issues in the selected post\nconst post = $input.first().json;\nconst config = $('Configuration').first().json;\n\nconst title = post.title || '';\nconst content = post.content || '';\nconst focusKeyword = post.focusKeyword || '';\nconst seoTitle = post.seoTitle || title;\nconst seoDescription = post.seoDescription || '';\nconst currentScore = post.seoScore || 0;\n\n// Strip HTML for analysis\nconst contentText = content.replace(/<[^>]*>/g, ' ').replace(/\\s+/g, ' ').trim();\nconst wordCount = contentText.split(/\\s+/).filter(w => w.length > 1).length;\n\n// Safety net: skip empty/stub posts that slipped through\nif (!title.trim() && wordCount < 50) {\n  console.log(`â›” Skipping empty/stub post ID ${post.id} - no title and only ${wordCount} words`);\n  return [];\n}\n\nconst contentLower = contentText.toLowerCase();\nconst keywordLower = focusKeyword.toLowerCase();\n\nconst issues = [];\nconst improvements = [];\n\n// 1. Focus Keyword\nif (!focusKeyword || focusKeyword.length < 2) {\n  issues.push('âŒ Missing focus keyword');\n  improvements.push('Add a 2-4 word focus keyword');\n}\n\n// 2. Keyword in Title\nif (focusKeyword && !seoTitle.toLowerCase().includes(keywordLower)) {\n  issues.push('âŒ Focus keyword not in SEO title');\n  improvements.push('Include focus keyword at beginning of title');\n}\n\n// 3. Keyword in Meta Description\nif (focusKeyword && !seoDescription.toLowerCase().includes(keywordLower)) {\n  issues.push('âŒ Focus keyword not in meta description');\n  improvements.push('Add focus keyword to meta description');\n}\n\n// 4. Content Length\nif (wordCount < 2000) {\n  issues.push(`âŒ Content too short (${wordCount} words, need 2500+)`);\n  improvements.push(`Expand content by ${2500 - wordCount}+ words`);\n} else if (wordCount < 2500) {\n  issues.push(`âš ï¸ Content slightly short (${wordCount} words)`);\n  improvements.push('Add 300-500 more words');\n}\n\n// 5. Keyword Density\nif (focusKeyword) {\n  const keywordRegex = new RegExp(keywordLower.replace(/[.*+?^${}()|[\\\\]\\\\]/g, '\\\\$&'), 'gi');\n  const keywordCount = (contentLower.match(keywordRegex) || []).length;\n  const density = (keywordCount / Math.max(wordCount, 1)) * 100;\n  if (density < 0.5) {\n    issues.push(`âŒ Keyword density too low (${density.toFixed(2)}%, need 1-1.5%)`);\n    improvements.push('Add focus keyword more naturally throughout content');\n  } else if (density > 2.5) {\n    issues.push(`âš ï¸ Keyword density too high (${density.toFixed(2)}%)`);\n    improvements.push('Reduce keyword stuffing');\n  }\n}\n\n// 6. Keyword in First Paragraph\nif (focusKeyword && !contentLower.substring(0, 300).includes(keywordLower)) {\n  issues.push('âŒ Focus keyword not in introduction');\n  improvements.push('Add focus keyword to first paragraph');\n}\n\n// 7. Headings\nconst h2Count = (content.match(/<h2[^>]*>/gi) || []).length;\nconst h3Count = (content.match(/<h3[^>]*>/gi) || []).length;\nif (h2Count < 3) {\n  issues.push(`âŒ Too few H2 headings (${h2Count}, need 4+)`);\n  improvements.push('Add more H2 section headings');\n}\nif (focusKeyword) {\n  const headings = content.match(/<h[2-6][^>]*>.*?<\\/h[2-6]>/gi) || [];\n  const keywordInHeadings = headings.filter(h => h.toLowerCase().includes(keywordLower)).length;\n  if (keywordInHeadings === 0) {\n    issues.push('âŒ Focus keyword not in any heading');\n    improvements.push('Include focus keyword in at least one H2/H3');\n  }\n}\n\n// 8. SEO Title Length\nif (seoTitle.length < 40 || seoTitle.length > 65) {\n  issues.push(`âš ï¸ SEO title length (${seoTitle.length} chars, ideal: 50-60)`);\n  improvements.push('Adjust SEO title to 50-60 characters');\n}\n\n// 9. Meta Description Length\nif (seoDescription.length < 120 || seoDescription.length > 160) {\n  issues.push(`âš ï¸ Meta description length (${seoDescription.length} chars, ideal: 150-160)`);\n  improvements.push('Adjust meta description to 150-160 characters');\n}\n\n// 10. Number in Title\nif (!/\\d/.test(title)) {\n  issues.push('âš ï¸ No number in title');\n  improvements.push('Add a number to title (e.g., \"7 Ways...\", \"5 Tips...\")');\n}\n\n// 11. Power Words\nconst powerWords = ['ultimate', 'essential', 'proven', 'complete', 'guide', '××“×¨×™×š', '××§×™×£', '×—×™×•× ×™', '××•×›×—', '×§×¨×™×˜×™'];\nif (!powerWords.some(pw => title.toLowerCase().includes(pw))) {\n  issues.push('âš ï¸ No power word in title');\n  improvements.push('Add power word (essential, proven, complete, guide)');\n}\n\n// 12. Internal/External Links\nconst internalLinks = (content.match(/href=[\"']https?:\\/\\/(www\\.)?tax4us\\.co\\.il[^\"']*/gi) || []).length;\nconst allLinks = (content.match(/href=[\"']https?:\\/\\/[^\"']*/gi) || []).length;\nconst externalLinks = allLinks - internalLinks;\n\nif (internalLinks < 2) {\n  issues.push(`âŒ Too few internal links (${internalLinks}, need 3+)`);\n  improvements.push('Add 2-3 internal links to other Tax4US articles');\n}\nif (externalLinks < 1) {\n  issues.push(`âš ï¸ No external links`);\n  improvements.push('Add 1-2 external links to authoritative sources (IRS, etc.)');\n}\n\n// 13. Paragraph Length\nconst paragraphs = content.split(/<\\/p>/i).map(p => p.replace(/<[^>]*>/g, ' ').trim()).filter(p => p.length > 0);\nconst longParagraphs = paragraphs.filter(p => p.split(/\\s+/).length > 150).length;\nif (longParagraphs > 2) {\n  issues.push(`âš ï¸ ${longParagraphs} paragraphs are too long (>150 words)`);\n  improvements.push('Break long paragraphs into shorter ones (max 120 words)');\n}\n\nconsole.log(`ğŸ“Š Found ${issues.length} SEO issues for \"${title}\"`);\n\nreturn [{\n  json: {\n    ...post,\n    issues: issues,\n    improvements: improvements,\n    issueCount: issues.length,\n    wordCount: wordCount,\n    h2Count: h2Count,\n    h3Count: h3Count,\n    internalLinks: internalLinks,\n    externalLinks: externalLinks,\n    targetScore: config.targetScore || 95,\n    analysisComplete: true\n  }\n}];"
      },
      "id": "ec22539e-2c03-4ffa-bf43-8f6d94b99e31",
      "name": "Analyze SEO Issues",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8176,
        4816
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=**CURRENT POST TO IMPROVE:**\n- Title: {{ $json.title }}\n- Current SEO Score: {{ $json.seoScore }}/100\n- Target Score: {{ $json.targetScore }}/100\n- Focus Keyword: {{ $json.focusKeyword || 'NOT SET - you must suggest one' }}\n- Word Count: {{ $json.wordCount }} words\n- Language: {{ $json.lang === 'he' ? 'Hebrew' : 'English' }}\n\n**IDENTIFIED SEO ISSUES:**\n{{ $json.issues.join('\\n') }}\n\n**REQUIRED IMPROVEMENTS:**\n{{ $json.improvements.join('\\n') }}\n\n**CURRENT CONTENT:**\n{{ $json.content }}\n\n---\n\n**YOUR TASK:**\nEnhance this existing content to achieve a Rank Math score of {{ $json.targetScore }}+/100.\n\n**OUTPUT FORMAT - Return ONLY valid JSON:**\n{\n  \"improvedTitle\": \"{{ $json.lang === 'he' ? '×›×•×ª×¨×ª ××©×•×¤×¨×ª ×‘×¢×‘×¨×™×ª (×—×™×™×‘×ª ×œ×›×œ×•×œ ××¡×¤×¨ ×•××™×œ×ª ×›×•×—)' : 'Improved English title (must include number and power word)' }}\",\n  \"improvedContent\": \"Full improved content in {{ $json.lang === 'he' ? 'Hebrew' : 'English' }} - plain text with ## and ### for headings, preserve core message\",\n  \"focusKeyword\": \"{{ $json.focusKeyword || 'Best 2-4 word focus keyword' }}\",\n  \"seoTitle\": \"SEO title (50-60 chars, keyword at beginning)\",\n  \"seoDescription\": \"Meta description (150-160 chars, includes keyword)\",\n  \"changesSummary\": [\"Change 1\", \"Change 2\", \"Change 3\"]\n}\n\n**CRITICAL REQUIREMENTS:**\n1. PRESERVE the core message and topic - this is an EDIT, not a rewrite\n2. Keep the same language ({{ $json.lang === 'he' ? 'Hebrew' : 'English' }})\n3. Expand content to 2500+ words if currently under\n4. Add focus keyword naturally throughout (1-1.5% density)\n5. Include keyword in title, first paragraph, and at least one heading\n6. Keep paragraphs under 120 words\n7. Add ## H2 and ### H3 headings with keyword\n8. Title MUST include a number AND a power word\n9. Return ONLY valid JSON - no markdown blocks",
        "options": {
          "systemMessage": "You are an SEO optimization expert specializing in Hebrew and English content for Tax4US, a US-Israeli tax advisory service. Your task is to enhance existing content to achieve high Rank Math SEO scores (95+/100). You must preserve the core message and topic - this is an EDIT, not a rewrite. Return ONLY valid JSON with no markdown blocks."
        }
      },
      "id": "d0a0bb59-b8eb-4afb-a8f4-d48c11df5bd6",
      "name": "AI: Enhance Content for SEO",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -7952,
        4816
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "claude-sonnet-4-20250514"
        },
        "options": {
          "maxTokensToSample": 12000,
          "thinking": true
        }
      },
      "id": "7a81977f-c9d8-4a1c-9b2e-05ad918073d9",
      "name": "Claude Sonnet 4",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        -7888,
        5040
      ],
      "credentials": {
        "anthropicApi": {
          "id": "j1oGG5odUyZb049h",
          "name": "Anthropic Claude"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse AI Response for SEO Enhancement\nconst inputData = $input.first().json;\nconst originalPost = $('Analyze SEO Issues').first().json;\n\nlet jsonText = null;\n\n// Extract from AI Agent output\nif (Array.isArray(inputData.output)) {\n  for (const item of inputData.output) {\n    if (item.type === 'text' && item.text) {\n      jsonText = item.text;\n      break;\n    }\n  }\n} else if (typeof inputData.output === 'string') {\n  jsonText = inputData.output;\n} else if (inputData.output?.title || inputData.output?.improvedTitle) {\n  return [{ json: { ...originalPost, improved: inputData.output } }];\n}\n\nif (!jsonText) jsonText = inputData.text || inputData.response || inputData.content || '';\nif (!jsonText) throw new Error('No output from AI Agent');\n\n// â”€â”€ Strip thinking tags (Claude thinking mode) â”€â”€\njsonText = String(jsonText)\n  .replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '')\n  .trim();\n\n// â”€â”€ Clean markdown code fences â”€â”€\nlet cleaned = jsonText\n  .replace(/```json\\s*/gi, '')\n  .replace(/```\\s*/g, '')\n  .trim();\n\n// â”€â”€ Find the root JSON object using brace-depth tracking â”€â”€\n// This is immune to stray braces in thinking/preamble text\nlet parsed = null;\n\nfunction extractRootJson(text) {\n  const start = text.indexOf('{');\n  if (start === -1) return null;\n\n  let depth = 0;\n  let inStr = false;\n  let esc = false;\n\n  for (let i = start; i < text.length; i++) {\n    const ch = text[i];\n    if (esc) { esc = false; continue; }\n    if (ch === '\\\\' && inStr) { esc = true; continue; }\n    if (ch === '\"') { inStr = !inStr; continue; }\n    if (inStr) continue;\n    if (ch === '{') depth++;\n    if (ch === '}') {\n      depth--;\n      if (depth === 0) return text.substring(start, i + 1);\n    }\n  }\n  return null; // unclosed object\n}\n\nconst jsonStr = extractRootJson(cleaned);\n\nif (jsonStr) {\n  try {\n    const sanitized = jsonStr\n      .replace(/,\\s*}/g, '}')\n      .replace(/,\\s*]/g, ']');\n    parsed = JSON.parse(sanitized);\n  } catch (e) {\n    console.log('âš ï¸ JSON.parse failed:', e.message);\n    console.log('âš ï¸ Extracted JSON (first 300 chars):', jsonStr.substring(0, 300));\n  }\n}\n\n// â”€â”€ Fallback: regex field extraction â”€â”€\nif (!parsed || !parsed.improvedContent) {\n  console.log('âš ï¸ Primary parse failed â€“ falling back to regex field extraction');\n\n  const extractField = (name) => {\n    const re = new RegExp(\n      `\"${name}\"\\\\s*:\\\\s*\"((?:[^\"\\\\\\\\]|\\\\\\\\.)*)\"`, 's'\n    );\n    const m = cleaned.match(re);\n    return m\n      ? m[1].replace(/\\\\n/g, '\\n').replace(/\\\\\"/g, '\"').replace(/\\\\\\\\/g, '\\\\')\n      : '';\n  };\n\n  const extractArray = (name) => {\n    const re = new RegExp(`\"${name}\"\\\\s*:\\\\s*\\\\[([^\\\\]]*)]`);\n    const m = cleaned.match(re);\n    if (!m) return [];\n    try { return JSON.parse('[' + m[1] + ']'); } catch { return []; }\n  };\n\n  const content = extractField('improvedContent');\n  if (content) {\n    parsed = {\n      improvedTitle: extractField('improvedTitle'),\n      improvedContent: content,\n      focusKeyword: extractField('focusKeyword'),\n      seoTitle: extractField('seoTitle'),\n      seoDescription: extractField('seoDescription'),\n      changesSummary: extractArray('changesSummary'),\n    };\n  }\n}\n\nif (!parsed || !parsed.improvedContent) {\n  // Log raw output for debugging before throwing\n  console.log('âŒ Raw AI output (first 500 chars):', String(jsonText).substring(0, 500));\n  throw new Error('Failed to parse AI response â€“ AI may not have returned valid JSON');\n}\n\nconsole.log('âœ… Parsed AI enhancement:', {\n  titleLength: parsed.improvedTitle?.length,\n  contentLength: parsed.improvedContent?.length,\n  keyword: parsed.focusKeyword,\n});\n\nreturn [{\n  json: {\n    ...originalPost,\n    improved: {\n      title: parsed.improvedTitle || originalPost.title,\n      content: parsed.improvedContent,\n      focusKeyword: parsed.focusKeyword || originalPost.focusKeyword,\n      seoTitle: parsed.seoTitle,\n      seoDescription: parsed.seoDescription,\n      changesSummary: parsed.changesSummary || [],\n    },\n  },\n}];"
      },
      "id": "e6b12fed-e35b-49e3-9081-59a15efdb3e3",
      "name": "Parse AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7600,
        4816
      ]
    },
    {
      "parameters": {
        "jsCode": "// Convert markdown headings to Gutenberg blocks\nconst data = $input.first().json;\nconst improved = data.improved;\n\nif (!improved || !improved.content) throw new Error('No improved content found');\n\nlet content = improved.content;\nconst title = improved.title || data.title;\nconst escapeHtml = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\nconst titleEscaped = escapeHtml(title);\n\nlet paragraphs = content.split(/\\n\\n+/).map(p => p.trim()).filter(p => p.length > 0);\nif (paragraphs.length === 1) paragraphs = content.split(/\\n+/).map(p => p.trim()).filter(p => p.length > 0);\n\nconst buildBlock = (para) => {\n  const trimmed = para.trim();\n  if (trimmed.startsWith('### ')) {\n    const text = trimmed.substring(4).trim();\n    return `<!-- wp:heading {\"level\":3,\"style\":{\"color\":{\"text\":\"#666666\"}}} -->\\n<h3 class=\"has-text-color\" style=\"color:#666666\">${escapeHtml(text)}</h3>\\n<!-- /wp:heading -->`;\n  }\n  if (trimmed.startsWith('## ')) {\n    const text = trimmed.substring(3).trim();\n    return `<!-- wp:heading {\"level\":2,\"style\":{\"color\":{\"text\":\"#8fb634\"}}} -->\\n<h2 class=\"has-text-color\" style=\"color:#8fb634\">${escapeHtml(text)}</h2>\\n<!-- /wp:heading -->`;\n  }\n  return `<!-- wp:paragraph -->\\n<p>${escapeHtml(para)}</p>\\n<!-- /wp:paragraph -->`;\n};\n\nconst contentBlocks = paragraphs.map(p => buildBlock(p)).join('\\n\\n');\nconst originalContent = data.content || '';\nconst hasVideoBanner = originalContent.includes('wp-block-cover__video-background');\n\nlet gutenbergContent;\nif (hasVideoBanner) {\n  const coverEndIndex = originalContent.indexOf('<!-- /wp:cover -->');\n  if (coverEndIndex > -1) {\n    const banner = originalContent.substring(0, coverEndIndex + 18);\n    const sidebarMatch = originalContent.match(/<!-- wp:column \\{\"width\":\"25%\"\\}[\\s\\S]*?<!-- \\/wp:column -->/s);\n    const sidebar = sidebarMatch ? sidebarMatch[0] : '';\n    gutenbergContent = `${banner}\\n\\n<!-- wp:columns {\"style\":{\"spacing\":{\"margin\":{\"top\":\"32px\"}}}} -->\\n<div class=\"wp-block-columns\" style=\"margin-top:32px\">\\n\\n${sidebar}\\n\\n<!-- wp:column {\"width\":\"75%\"} -->\\n<div class=\"wp-block-column\" style=\"flex-basis:75%\">\\n<!-- wp:heading {\"level\":2,\"style\":{\"color\":{\"text\":\"#8fb634\"}}} -->\\n<h2 class=\"has-text-color\" style=\"color:#8fb634\">${titleEscaped}</h2>\\n<!-- /wp:heading -->\\n\\n${contentBlocks}\\n\\n</div><!-- /wp:column --></div><!-- /wp:columns -->`;\n  } else { gutenbergContent = contentBlocks; }\n} else {\n  gutenbergContent = `<!-- wp:cover {\"url\":\"https://tax4us.co.il/wp-content/uploads/2023/11/Converted-11.webp\",\"id\":1129,\"dimRatio\":50,\"overlayColor\":\"black\",\"minHeight\":60,\"minHeightUnit\":\"vh\",\"align\":\"full\"} -->\\n<div class=\"wp-block-cover alignfull\" style=\"min-height:60vh\"><span aria-hidden=\"true\" class=\"wp-block-cover__background has-black-background-color has-background-dim\"></span><img class=\"wp-block-cover__image-background wp-image-1129\" alt=\"\" src=\"https://tax4us.co.il/wp-content/uploads/2023/11/Converted-11.webp\" data-object-fit=\"cover\"/><div class=\"wp-block-cover__inner-container\"><!-- wp:heading {\"textAlign\":\"center\",\"level\":1} -->\\n<h1 class=\"has-text-align-center has-text-color\" style=\"color:#ffffff;font-size:clamp(32px, 5vw, 64px);font-weight:800\">${titleEscaped}</h1>\\n<!-- /wp:heading --></div></div>\\n<!-- /wp:cover -->\\n\\n<!-- wp:columns {\"style\":{\"spacing\":{\"margin\":{\"top\":\"32px\"}}}} -->\\n<div class=\"wp-block-columns\" style=\"margin-top:32px\">\\n\\n<!-- wp:column {\"width\":\"25%\"} --><div class=\"wp-block-column\" style=\"flex-basis:25%\">\\n<!-- wp:group {\"style\":{\"border\":{\"width\":\"4px\",\"color\":\"#a1cd3a\",\"radius\":\"12px\"}},\"backgroundColor\":\"white\"} -->\\n<div class=\"wp-block-group has-white-background-color has-background\" style=\"border-color:#a1cd3a;border-width:4px;border-radius:12px\">\\n<h2 class=\"has-text-color has-background\" style=\"background-color:#a1cd3a;color:#ffffff;padding:12px\">${data.lang === 'he' ? '××××¨×™× ×“×•××™×' : 'Related Articles'}</h2>\\n<!-- wp:query {\"queryId\":1,\"query\":{\"perPage\":5,\"postType\":\"post\",\"order\":\"desc\",\"orderBy\":\"date\",\"exclude\":[${data.id}]}} -->\\n<div class=\"wp-block-query\"><!-- wp:post-template -->\\n<!-- wp:group {\"style\":{\"spacing\":{\"padding\":{\"left\":\"16px\",\"right\":\"16px\"}}}} -->\\n<div class=\"wp-block-group\" style=\"padding-left:16px;padding-right:16px\">\\n<!-- wp:post-featured-image {\"isLink\":true,\"width\":\"100%\",\"height\":\"120px\",\"style\":{\"border\":{\"radius\":\"8px\"}}} /-->\\n<!-- wp:post-title {\"isLink\":true,\"fontSize\":\"medium\"} /--><!-- wp:post-date {\"fontSize\":\"small\"} /-->\\n</div><!-- /wp:group --><!-- /wp:post-template --></div><!-- /wp:query -->\\n</div><!-- /wp:group --></div><!-- /wp:column -->\\n\\n<!-- wp:column {\"width\":\"75%\"} --><div class=\"wp-block-column\" style=\"flex-basis:75%\">\\n<!-- wp:heading {\"level\":2,\"style\":{\"color\":{\"text\":\"#8fb634\"}}} -->\\n<h2 class=\"has-text-color\" style=\"color:#8fb634\">${titleEscaped}</h2>\\n<!-- /wp:heading -->\\n\\n${contentBlocks}\\n\\n</div><!-- /wp:column --></div><!-- /wp:columns -->`;\n}\n\nreturn [{json: {...data, gutenbergContent: gutenbergContent, improved: {...improved, gutenbergContent: gutenbergContent}}}];"
      },
      "id": "41cd045e-1710-4cdd-af8c-69325a9d8e8d",
      "name": "Build Gutenberg Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7376,
        4816
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "msg",
              "name": "slackMessage",
              "value": "=ğŸ”§ *SEO Post Enhancement Ready for Review*\n\nğŸ“ *Post:* {{ $json.title.replace(/&#8221;/g, '\"').replace(/&#8220;/g, '\"').replace(/&#8217;/g, \"'\").replace(/&#8216;/g, \"'\").replace(/&quot;/g, '\"').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&#039;/g, \"'\") }}\nğŸ”— *URL:* {{ $json.link }}\nğŸŒ *Language:* {{ $json.lang === 'he' ? 'Hebrew ğŸ‡®ğŸ‡±' : 'English ğŸ‡ºğŸ‡¸' }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“Š *SCORE COMPARISON*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*Before:* {{ $json.seoScore }}/100\n*Target:* {{ $json.targetScore }}/100\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâŒ *ISSUES FIXED*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n{{ $json.issues.slice(0, 5).join('\\n') }}\n{{ $json.issues.length > 5 ? '... and ' + ($json.issues.length - 5) + ' more' : '' }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœï¸ *PROPOSED CHANGES*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*New Title:* {{ $json.improved.title.replace(/&#8221;/g, '\"').replace(/&#8220;/g, '\"').replace(/&#8217;/g, \"'\").replace(/&#8216;/g, \"'\").replace(/&quot;/g, '\"').replace(/&amp;/g, '&').replace(/&#039;/g, \"'\") }}\n*Focus Keyword:* {{ $json.improved.focusKeyword }}\n*SEO Title:* {{ $json.improved.seoTitle.replace(/&#8221;/g, '\"').replace(/&#8220;/g, '\"').replace(/&#8217;/g, \"'\").replace(/&#8216;/g, \"'\").replace(/&quot;/g, '\"').replace(/&amp;/g, '&').replace(/&#039;/g, \"'\") }}\n\n{{ $json.improved.changesSummary ? '*Summary:*\\n' + $json.improved.changesSummary.slice(0, 5).join('\\n') : '' }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*Click âœ… Approve to update the post*\n*Click âœï¸ Reject to skip this post*",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "bb417c29-7232-40fc-be1a-30b544ea164f",
      "name": "Format Approval Message",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -7152,
        4816
      ]
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "operation": "sendAndWait",
        "user": {
          "__rl": true,
          "value": "U09NNMEDNEQ",
          "mode": "list",
          "cachedResultName": "ben"
        },
        "message": "={{ $json.slackMessage }}",
        "approvalOptions": {
          "values": {
            "approvalType": "double",
            "approveLabel": "âœ… Approve & Update",
            "disapproveLabel": "âœï¸ Fix Post"
          }
        },
        "options": {
          "appendAttribution": false
        }
      },
      "id": "289634c2-b4a9-401e-baf5-807f75ab3c03",
      "name": "Send Approval Request",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        -6928,
        4816
      ],
      "webhookId": "seo-editor-approval",
      "credentials": {
        "slackOAuth2Api": {
          "id": "TtgEhzUDH0MsxlGp",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "caseSensitive": true,
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "approved",
              "leftValue": "={{ $json.data?.approved ?? $json.approved ?? false }}",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ec812e9a-2801-4a42-b422-948c56607cb7",
      "name": "Approved?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6704,
        4816
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://tax4us.co.il/wp-json/wp/v2/posts/' + $('Build Gutenberg Content').first().json.id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "wordpressApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  title: $('Build Gutenberg Content').first().json.improved?.title || $('Build Gutenberg Content').first().json.title || '',\n  content: $('Build Gutenberg Content').first().json.improved?.gutenbergContent || '',\n  meta: {\n    rank_math_focus_keyword: $('Build Gutenberg Content').first().json.improved?.focusKeyword || '',\n    rank_math_title: $('Build Gutenberg Content').first().json.improved?.seoTitle || '',\n    rank_math_description: $('Build Gutenberg Content').first().json.improved?.seoDescription || '',\n    _seo_editor_processed: $now.toISO()\n  }\n}) }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "70bc0582-c199-4f9c-9b84-becc463508b1",
      "name": "HTTP: Update WordPress Post",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4560,
        5136
      ],
      "credentials": {
        "wordpressApi": {
          "id": "S5Sr1ruBZOv5jSn5",
          "name": "Wordpress account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Recalculate SEO Score after update (handles both original and revision paths)\nconst postData = $input.first().json;\nconst originalData = $('Analyze SEO Issues').first().json;\n\n// Try to get improved data from revision path first, then fall back to original path\nlet improvedData;\ntry {\n  improvedData = $('Build Revised Gutenberg').first().json.improved;\n} catch (e) {\n  improvedData = $('Build Gutenberg Content').first().json.improved;\n}\n\nlet content = '';\nif (typeof postData.content === 'string') content = postData.content;\nelse if (postData.content?.rendered) content = postData.content.rendered;\n\nconst title = improvedData.title || '';\nconst focusKeyword = improvedData.focusKeyword || '';\nconst seoTitle = improvedData.seoTitle || title;\nconst seoDesc = improvedData.seoDescription || '';\n\nconst contentText = content.replace(/<[^>]*>/g, ' ').replace(/\\s+/g, ' ').trim();\nconst wordCount = contentText.split(/\\s+/).filter(w => w.length > 1).length;\nconst contentLower = contentText.toLowerCase();\nconst keywordLower = focusKeyword.toLowerCase();\n\nlet totalScore = 0;\nif (focusKeyword.length > 0) totalScore += 6;\nif (focusKeyword && seoTitle.toLowerCase().includes(keywordLower)) totalScore += 10;\nelse if (seoTitle.length > 0) totalScore += 4;\nif (focusKeyword && seoDesc.toLowerCase().includes(keywordLower)) totalScore += 8;\nelse if (seoDesc.length >= 60) totalScore += 5;\n\nconst slug = postData.slug || '';\nif (focusKeyword && slug.toLowerCase().includes(keywordLower.replace(/\\s+/g, '-'))) totalScore += 6;\nelse if (slug.length > 0) totalScore += 3;\n\nif (focusKeyword && contentLower.substring(0, 300).includes(keywordLower)) totalScore += 8;\nelse if (contentText.length > 100) totalScore += 4;\n\nif (seoTitle.length >= 20 && seoTitle.length <= 75) totalScore += 6;\nelse if (seoTitle.length > 0) totalScore += 4;\n\nif (seoDesc.length >= 90 && seoDesc.length <= 180) totalScore += 6;\nelse if (seoDesc.length >= 50) totalScore += 4;\n\nif (wordCount >= 2000) totalScore += 12;\nelse if (wordCount >= 1500) totalScore += 10;\nelse if (wordCount >= 1000) totalScore += 8;\nelse if (wordCount >= 500) totalScore += 6;\n\nif (focusKeyword) {\n  const keywordRegex = new RegExp(keywordLower.replace(/[.*+?^${}()|[\\\\]\\\\]/g, '\\\\$&'), 'gi');\n  const keywordCount = (contentLower.match(keywordRegex) || []).length;\n  const density = (keywordCount / Math.max(wordCount, 1)) * 100;\n  if (density >= 0.2 && density <= 3.5) totalScore += 10;\n  else if (density >= 0.1) totalScore += 7;\n  else if (keywordCount > 0) totalScore += 5;\n}\n\nconst headings = content.match(/<h[2-6][^>]*>.*?<\\/h[2-6]>/gi) || [];\nconst headingsWithKeyword = headings.filter(h => focusKeyword && h.toLowerCase().includes(keywordLower)).length;\nif (headingsWithKeyword >= 1) totalScore += 8;\nelse if (headings.length >= 3) totalScore += 5;\n\nconst paragraphs = content.split(/<\\/p>/i).map(p => p.replace(/<[^>]*>/g, ' ').trim()).filter(p => p.length > 0);\nconst longParagraphs = paragraphs.filter(p => p.split(/\\s+/).length > 200).length;\nif (longParagraphs === 0) totalScore += 6;\nelse if (longParagraphs <= 3) totalScore += 4;\n\nif (/\\d/.test(title)) totalScore += 5;\n\nconst powerWords = ['ultimate', 'essential', 'proven', 'complete', 'guide', '××“×¨×™×š', '××§×™×£', '×—×™×•× ×™', '××•×›×—', '×§×¨×™×˜×™'];\nif (powerWords.some(pw => title.toLowerCase().includes(pw))) totalScore += 6;\n\nconst internalLinks = (content.match(/href=[\"']https?:\\/\\/(www\\.)?tax4us\\.co\\.il[^\"']*/gi) || []).length;\nif (internalLinks >= 2) totalScore += 6;\nelse if (internalLinks >= 1) totalScore += 4;\nelse totalScore += 2;\n\nconst allLinks = (content.match(/href=[\"']https?:\\/\\/[^\"']*/gi) || []).length;\nconst externalLinks = allLinks - internalLinks;\nif (externalLinks >= 1) totalScore += 5;\nelse totalScore += 2;\n\nif (headings.length >= 3) totalScore += 4;\nelse if (headings.length >= 1) totalScore += 2;\n\nif (seoDesc.length > 0) totalScore += 3;\n\nconst newScore = Math.min(100, Math.max(0, Math.round(totalScore)));\nconst improvement = newScore - originalData.seoScore;\n\nconsole.log(`ğŸ“Š Score: ${originalData.seoScore} â†’ ${newScore} (+${improvement})`);\n\nreturn [{json: {postId: postData.id, title: title, link: postData.link, oldScore: originalData.seoScore, newScore: newScore, improvement: improvement, wordCount: wordCount, focusKeyword: focusKeyword}}];"
      },
      "id": "243cd76c-8ae7-4e1d-9f32-4b96168a96ec",
      "name": "Recalculate SEO Score",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4336,
        4816
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://tax4us.co.il/wp-json/wp/v2/posts/' + $json.postId }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "wordpressApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { meta: { rank_math_seo_score: $json.newScore } } }}",
        "options": {}
      },
      "id": "aa6f7316-89cf-41b8-aac1-5d7ea48ce679",
      "name": "HTTP: Save New Score",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4112,
        4816
      ],
      "credentials": {
        "wordpressApi": {
          "id": "S5Sr1ruBZOv5jSn5",
          "name": "Wordpress account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "user",
        "user": {
          "__rl": true,
          "value": "U09NNMEDNEQ",
          "mode": "list",
          "cachedResultName": "ben"
        },
        "text": "=âœ… *SEO Post Updated Successfully!*\n\nğŸ“ *{{ $('Recalculate SEO Score').first().json.title }}*\nğŸ”— {{ $('Recalculate SEO Score').first().json.link }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“Š *SCORE IMPROVEMENT*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*Before:* {{ $('Recalculate SEO Score').first().json.oldScore }}/100\n*After:* {{ $('Recalculate SEO Score').first().json.newScore }}/100\n*Improvement:* +{{ $('Recalculate SEO Score').first().json.improvement }} points ğŸ‰\n\n*Word Count:* {{ $('Recalculate SEO Score').first().json.wordCount }}\n*Focus Keyword:* {{ $('Recalculate SEO Score').first().json.focusKeyword }}",
        "otherOptions": {}
      },
      "id": "1f417673-146b-4d4d-b1a8-16a3807371d1",
      "name": "Notify: Success",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        -3888,
        4816
      ],
      "webhookId": "56650c59-94cd-4731-8757-558d2a0bb9b6",
      "credentials": {
        "slackOAuth2Api": {
          "id": "TtgEhzUDH0MsxlGp",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "operation": "sendAndWait",
        "user": {
          "__rl": true,
          "value": "U09NNMEDNEQ",
          "mode": "list",
          "cachedResultName": "ben"
        },
        "message": "=âŒ *SEO Enhancement Rejected*\n\nğŸ“ *Post:* {{ $('Analyze SEO Issues').first().json.title }}\n\n*Previous attempt:*\nâ€¢ Title: {{ $('Build Gutenberg Content').first().json.improved.title }}\nâ€¢ Focus Keyword: {{ $('Build Gutenberg Content').first().json.improved.focusKeyword }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ *Please provide feedback:*\nWhat should be changed? (Reply with your feedback)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        "responseType": "freeText",
        "options": {
          "appendAttribution": false
        }
      },
      "id": "4100bbb3-12b5-485c-9099-023e9f8e3677",
      "name": "Request Rejection Feedback",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        -6480,
        4720
      ],
      "webhookId": "seo-rejection-feedback",
      "credentials": {
        "slackOAuth2Api": {
          "id": "TtgEhzUDH0MsxlGp",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Track rejection count and check if we should continue\nconst feedbackData = $input.first().json;\nconst originalPost = $('Analyze SEO Issues').first().json;\nconst previousImproved = $('Build Gutenberg Content').first().json.improved;\n\n// Get rejection count from previous iterations or start at 1\nlet rejectionCount = 1;\ntry {\n  const prevCount = $('Check Rejection Count').first().json.rejectionCount;\n  if (prevCount) rejectionCount = prevCount + 1;\n} catch (e) {\n  // First rejection\n}\n\nconst maxRejections = 3;\nconst feedback = feedbackData.data?.response || feedbackData.response || feedbackData.text || 'No specific feedback provided';\n\nconsole.log(`ğŸ“ Rejection #${rejectionCount} - Feedback: ${feedback}`);\n\nreturn [{\n  json: {\n    ...originalPost,\n    previousImproved: previousImproved,\n    rejectionFeedback: feedback,\n    rejectionCount: rejectionCount,\n    maxRejections: maxRejections,\n    shouldContinue: rejectionCount < maxRejections\n  }\n}];"
      },
      "id": "55d88026-55ff-4c23-bc3c-c4505cebcc27",
      "name": "Check Rejection Count",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6256,
        4608
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "should-continue",
              "leftValue": "={{ $json.shouldContinue }}",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "0e40e06a-a793-426b-8f47-5d60098309d2",
      "name": "Continue Revising?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6032,
        4608
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=**ORIGINAL POST:**\n- Title: {{ $json.title }}\n- Language: {{ $json.lang === 'he' ? 'Hebrew' : 'English' }}\n- Current Score: {{ $json.seoScore }}/100\n- Target Score: {{ $json.targetScore }}/100\n\n**YOUR PREVIOUS ATTEMPT (REJECTED):**\n- Title: {{ $json.previousImproved.title }}\n- Focus Keyword: {{ $json.previousImproved.focusKeyword }}\n- SEO Title: {{ $json.previousImproved.seoTitle }}\n\n**REJECTION FEEDBACK FROM REVIEWER:**\n{{ $json.rejectionFeedback }}\n\n**ORIGINAL CONTENT:**\n{{ $json.content }}\n\n---\n\n**REJECTION COUNT:** {{ $json.rejectionCount }}/{{ $json.maxRejections }} (make it count!)\n\n**OUTPUT FORMAT - Return ONLY valid JSON:**\n{\n  \"improvedTitle\": \"Revised title addressing feedback\",\n  \"improvedContent\": \"Full revised content in {{ $json.lang === 'he' ? 'Hebrew' : 'English' }} - use ## and ### for headings\",\n  \"focusKeyword\": \"Focus keyword (may keep or change based on feedback)\",\n  \"seoTitle\": \"SEO title (50-60 chars)\",\n  \"seoDescription\": \"Meta description (150-160 chars)\",\n  \"changesSummary\": [\"How I addressed feedback point 1\", \"How I addressed feedback point 2\"],\n  \"feedbackAddressed\": \"Brief explanation of how the feedback was incorporated\"\n}\n\n**CRITICAL:** Address the reviewer's feedback directly. This is attempt {{ $json.rejectionCount + 1 }} of {{ $json.maxRejections }}.",
        "options": {
          "systemMessage": "You are an SEO optimization expert. Your previous enhancement was rejected and you must revise it based on reviewer feedback. Address the specific concerns raised while maintaining SEO best practices. Return ONLY valid JSON with no markdown blocks."
        }
      },
      "id": "2dd1bef5-a951-4cde-902b-52addd9ce6e2",
      "name": "AI: Revise with Feedback",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -5808,
        4752
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "claude-sonnet-4-20250514"
        },
        "options": {
          "maxTokensToSample": 12000,
          "thinking": true
        }
      },
      "id": "6b2de547-1ca7-4ee4-a108-c122335a90f6",
      "name": "Claude Sonnet 4 Revision",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        -5744,
        4976
      ],
      "credentials": {
        "anthropicApi": {
          "id": "j1oGG5odUyZb049h",
          "name": "Anthropic Claude"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse revised AI Response (same logic as original parse)\nconst inputData = $input.first().json;\nconst originalPost = $('Check Rejection Count').first().json;\n\nlet jsonText = null;\n\nif (Array.isArray(inputData.output)) {\n  for (const item of inputData.output) {\n    if (item.type === 'text' && item.text) { jsonText = item.text; break; }\n  }\n} else if (typeof inputData.output === 'string') {\n  jsonText = inputData.output;\n} else if (inputData.output?.improvedTitle) {\n  return [{json: {...originalPost, improved: inputData.output}}];\n}\n\nif (!jsonText) jsonText = inputData.text || inputData.response || inputData.content || '';\nif (!jsonText) throw new Error('No output from AI Agent');\n\nlet cleaned = String(jsonText).replace(/```json\\s*/gi, '').replace(/```\\s*/g, '').trim();\nconst jsonMatch = cleaned.match(/\\{[\\s\\S]*\\}/);\n\nlet parsed = null;\nif (jsonMatch) {\n  try {\n    let jsonStr = jsonMatch[0].replace(/,\\s*}/g, '}').replace(/,\\s*]/g, ']');\n    parsed = JSON.parse(jsonStr);\n  } catch (e) {\n    const extractField = (name) => {\n      const pattern = new RegExp(`\"${name}\"\\\\s*:\\\\s*\"((?:[^\"\\\\\\\\]|\\\\\\\\[\\\\s\\\\S])*?)\"`, 's');\n      const match = jsonText.match(pattern);\n      return match ? match[1].replace(/\\\\n/g, '\\n').replace(/\\\\\"/g, '\"') : '';\n    };\n    parsed = {\n      improvedTitle: extractField('improvedTitle'),\n      improvedContent: extractField('improvedContent'),\n      focusKeyword: extractField('focusKeyword'),\n      seoTitle: extractField('seoTitle'),\n      seoDescription: extractField('seoDescription'),\n      feedbackAddressed: extractField('feedbackAddressed')\n    };\n  }\n}\n\nif (!parsed || !parsed.improvedContent) throw new Error('Failed to parse revision response');\n\nconsole.log('âœ… Parsed revision:', {title: parsed.improvedTitle?.substring(0, 50), feedbackAddressed: parsed.feedbackAddressed?.substring(0, 100)});\n\nreturn [{\n  json: {\n    ...originalPost,\n    improved: {\n      title: parsed.improvedTitle || originalPost.title,\n      content: parsed.improvedContent,\n      focusKeyword: parsed.focusKeyword || originalPost.focusKeyword,\n      seoTitle: parsed.seoTitle,\n      seoDescription: parsed.seoDescription,\n      changesSummary: parsed.changesSummary || [],\n      feedbackAddressed: parsed.feedbackAddressed || ''\n    }\n  }\n}];"
      },
      "id": "f5f2d595-54d2-482d-82ef-5f0c4dc75c48",
      "name": "Parse Revision Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5744,
        4448
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build Gutenberg content from revision (reuse same logic)\nconst data = $input.first().json;\nconst improved = data.improved;\n\nif (!improved || !improved.content) throw new Error('No revised content found');\n\nlet content = improved.content;\nconst title = improved.title || data.title;\nconst escapeHtml = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\nconst titleEscaped = escapeHtml(title);\n\nlet paragraphs = content.split(/\\n\\n+/).map(p => p.trim()).filter(p => p.length > 0);\nif (paragraphs.length === 1) paragraphs = content.split(/\\n+/).map(p => p.trim()).filter(p => p.length > 0);\n\nconst buildBlock = (para) => {\n  const trimmed = para.trim();\n  if (trimmed.startsWith('### ')) {\n    return `<!-- wp:heading {\"level\":3,\"style\":{\"color\":{\"text\":\"#666666\"}}} -->\\n<h3 class=\"has-text-color\" style=\"color:#666666\">${escapeHtml(trimmed.substring(4).trim())}</h3>\\n<!-- /wp:heading -->`;\n  }\n  if (trimmed.startsWith('## ')) {\n    return `<!-- wp:heading {\"level\":2,\"style\":{\"color\":{\"text\":\"#8fb634\"}}} -->\\n<h2 class=\"has-text-color\" style=\"color:#8fb634\">${escapeHtml(trimmed.substring(3).trim())}</h2>\\n<!-- /wp:heading -->`;\n  }\n  return `<!-- wp:paragraph -->\\n<p>${escapeHtml(para)}</p>\\n<!-- /wp:paragraph -->`;\n};\n\nconst contentBlocks = paragraphs.map(p => buildBlock(p)).join('\\n\\n');\nconst originalContent = data.content || '';\nconst hasVideoBanner = originalContent.includes('wp-block-cover__video-background');\n\nlet gutenbergContent;\nif (hasVideoBanner) {\n  const coverEndIndex = originalContent.indexOf('<!-- /wp:cover -->');\n  if (coverEndIndex > -1) {\n    const banner = originalContent.substring(0, coverEndIndex + 18);\n    const sidebarMatch = originalContent.match(/<!-- wp:column \\{\"width\":\"25%\"\\}[\\s\\S]*?<!-- \\/wp:column -->/s);\n    const sidebar = sidebarMatch ? sidebarMatch[0] : '';\n    gutenbergContent = `${banner}\\n\\n<!-- wp:columns {\"style\":{\"spacing\":{\"margin\":{\"top\":\"32px\"}}}} -->\\n<div class=\"wp-block-columns\" style=\"margin-top:32px\">\\n\\n${sidebar}\\n\\n<!-- wp:column {\"width\":\"75%\"} -->\\n<div class=\"wp-block-column\" style=\"flex-basis:75%\">\\n<!-- wp:heading {\"level\":2,\"style\":{\"color\":{\"text\":\"#8fb634\"}}} -->\\n<h2 class=\"has-text-color\" style=\"color:#8fb634\">${titleEscaped}</h2>\\n<!-- /wp:heading -->\\n\\n${contentBlocks}\\n\\n</div><!-- /wp:column --></div><!-- /wp:columns -->`;\n  } else { gutenbergContent = contentBlocks; }\n} else {\n  gutenbergContent = `<!-- wp:cover {\"url\":\"https://tax4us.co.il/wp-content/uploads/2023/11/Converted-11.webp\",\"id\":1129,\"dimRatio\":50,\"overlayColor\":\"black\",\"minHeight\":60,\"minHeightUnit\":\"vh\",\"align\":\"full\"} -->\\n<div class=\"wp-block-cover alignfull\" style=\"min-height:60vh\"><span aria-hidden=\"true\" class=\"wp-block-cover__background has-black-background-color has-background-dim\"></span><img class=\"wp-block-cover__image-background wp-image-1129\" alt=\"\" src=\"https://tax4us.co.il/wp-content/uploads/2023/11/Converted-11.webp\" data-object-fit=\"cover\"/><div class=\"wp-block-cover__inner-container\"><!-- wp:heading {\"textAlign\":\"center\",\"level\":1} -->\\n<h1 class=\"has-text-align-center has-text-color\" style=\"color:#ffffff;font-size:clamp(32px, 5vw, 64px);font-weight:800\">${titleEscaped}</h1>\\n<!-- /wp:heading --></div></div>\\n<!-- /wp:cover -->\\n\\n<!-- wp:columns {\"style\":{\"spacing\":{\"margin\":{\"top\":\"32px\"}}}} -->\\n<div class=\"wp-block-columns\" style=\"margin-top:32px\">\\n\\n<!-- wp:column {\"width\":\"25%\"} --><div class=\"wp-block-column\" style=\"flex-basis:25%\">\\n<!-- wp:group {\"style\":{\"border\":{\"width\":\"4px\",\"color\":\"#a1cd3a\",\"radius\":\"12px\"}},\"backgroundColor\":\"white\"} -->\\n<div class=\"wp-block-group has-white-background-color has-background\" style=\"border-color:#a1cd3a;border-width:4px;border-radius:12px\">\\n<h2 class=\"has-text-color has-background\" style=\"background-color:#a1cd3a;color:#ffffff;padding:12px\">${data.lang === 'he' ? '××××¨×™× ×“×•××™×' : 'Related Articles'}</h2>\\n<!-- wp:query {\"queryId\":1,\"query\":{\"perPage\":5,\"postType\":\"post\",\"order\":\"desc\",\"orderBy\":\"date\",\"exclude\":[${data.id}]}} -->\\n<div class=\"wp-block-query\"><!-- wp:post-template -->\\n<!-- wp:group {\"style\":{\"spacing\":{\"padding\":{\"left\":\"16px\",\"right\":\"16px\"}}}} -->\\n<div class=\"wp-block-group\" style=\"padding-left:16px;padding-right:16px\">\\n<!-- wp:post-featured-image {\"isLink\":true,\"width\":\"100%\",\"height\":\"120px\",\"style\":{\"border\":{\"radius\":\"8px\"}}} /-->\\n<!-- wp:post-title {\"isLink\":true,\"fontSize\":\"medium\"} /--><!-- wp:post-date {\"fontSize\":\"small\"} /-->\\n</div><!-- /wp:group --><!-- /wp:post-template --></div><!-- /wp:query -->\\n</div><!-- /wp:group --></div><!-- /wp:column -->\\n\\n<!-- wp:column {\"width\":\"75%\"} --><div class=\"wp-block-column\" style=\"flex-basis:75%\">\\n<!-- wp:heading {\"level\":2,\"style\":{\"color\":{\"text\":\"#8fb634\"}}} -->\\n<h2 class=\"has-text-color\" style=\"color:#8fb634\">${titleEscaped}</h2>\\n<!-- /wp:heading -->\\n\\n${contentBlocks}\\n\\n</div><!-- /wp:column --></div><!-- /wp:columns -->`;\n}\n\nreturn [{json: {...data, gutenbergContent: gutenbergContent, improved: {...improved, gutenbergContent: gutenbergContent}}}];"
      },
      "id": "ba781ff4-64c9-4fc6-bfe2-9f2150a748b4",
      "name": "Build Revised Gutenberg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5456,
        4448
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "msg",
              "name": "slackMessage",
              "value": "=ğŸ”„ *REVISED SEO Enhancement (Attempt {{ $json.rejectionCount + 1 }}/{{ $json.maxRejections }})*\n\nğŸ“ *Post:* {{ $json.title.replace(/&#8221;/g, '\"').replace(/&#8220;/g, '\"').replace(/&#8217;/g, \"'\").replace(/&#8216;/g, \"'\").replace(/&quot;/g, '\"').replace(/&amp;/g, '&').replace(/&#039;/g, \"'\") }}\nğŸ”— *URL:* {{ $json.link }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“Š *SCORE TARGET*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*Current:* {{ $json.seoScore }}/100 â†’ *Target:* {{ $json.targetScore }}/100\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¬ *YOUR FEEDBACK WAS:*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n{{ $json.rejectionFeedback }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ… *HOW FEEDBACK WAS ADDRESSED:*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n{{ $json.improved.feedbackAddressed || 'See changes below' }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœï¸ *REVISED PROPOSAL*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*New Title:* {{ $json.improved.title.replace(/&#8221;/g, '\"').replace(/&#8220;/g, '\"').replace(/&#8217;/g, \"'\").replace(/&#8216;/g, \"'\").replace(/&quot;/g, '\"').replace(/&amp;/g, '&').replace(/&#039;/g, \"'\") }}\n*Focus Keyword:* {{ $json.improved.focusKeyword }}\n*SEO Title:* {{ $json.improved.seoTitle.replace(/&#8221;/g, '\"').replace(/&#8220;/g, '\"').replace(/&#8217;/g, \"'\").replace(/&#8216;/g, \"'\").replace(/&quot;/g, '\"').replace(/&amp;/g, '&').replace(/&#039;/g, \"'\") }}\n\n{{ $json.improved.changesSummary ? '*Changes:*\\n' + $json.improved.changesSummary.slice(0, 5).join('\\n') : '' }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*Click âœ… Approve Revision*\n*Click âŒ Reject Again*",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "c896af3e-bd2e-4442-859a-4fdbc43e990a",
      "name": "Format Revision Approval",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5232,
        4448
      ]
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "operation": "sendAndWait",
        "user": {
          "__rl": true,
          "value": "U09NNMEDNEQ",
          "mode": "list",
          "cachedResultName": "ben"
        },
        "message": "={{ $json.slackMessage }}",
        "approvalOptions": {
          "values": {
            "approvalType": "double",
            "approveLabel": "âœ… Approve Revision",
            "disapproveLabel": "âŒ Reject Again"
          }
        },
        "options": {
          "appendAttribution": false
        }
      },
      "id": "8af0b3ca-8ccc-45d7-99d5-f655fc6dfff0",
      "name": "Send Revision Approval",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        -5008,
        4448
      ],
      "webhookId": "seo-revision-approval",
      "credentials": {
        "slackOAuth2Api": {
          "id": "TtgEhzUDH0MsxlGp",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "caseSensitive": true,
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "revision-approved",
              "leftValue": "={{ $json.data?.approved ?? $json.approved ?? false }}",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "2fd342e1-09d7-4134-8171-de535fcf50b6",
      "name": "Revision Approved?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4784,
        4720
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://tax4us.co.il/wp-json/wp/v2/posts/' + $('Build Revised Gutenberg').first().json.id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "wordpressApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  title: $('Build Revised Gutenberg').first().json.improved?.title || $('Build Revised Gutenberg').first().json.title || '',\n  content: $('Build Revised Gutenberg').first().json.improved?.gutenbergContent || '',\n  meta: {\n    rank_math_focus_keyword: $('Build Revised Gutenberg').first().json.improved?.focusKeyword || '',\n    rank_math_title: $('Build Revised Gutenberg').first().json.improved?.seoTitle || '',\n    rank_math_description: $('Build Revised Gutenberg').first().json.improved?.seoDescription || '',\n    _seo_editor_processed: $now.toISO()\n  }\n}) }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "18c6ffe2-4d27-4a96-a3d7-09dc0b890d9f",
      "name": "HTTP: Update Post (Revision)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4560,
        4720
      ],
      "credentials": {
        "wordpressApi": {
          "id": "S5Sr1ruBZOv5jSn5",
          "name": "Wordpress account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "user",
        "user": {
          "__rl": true,
          "value": "U09NNMEDNEQ",
          "mode": "list",
          "cachedResultName": "ben"
        },
        "text": "=âœ… *All posts have good SEO scores!*\n\nNo posts found with scores below {{ $('Configuration').first().json.scoreThreshold }}.\n\n_Checked on {{ $now.format('MMMM d, yyyy h:mm a') }}_",
        "otherOptions": {}
      },
      "id": "b5d5c2b9-b3de-4886-b23e-4fbb92671348",
      "name": "Notify: All Good",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        -8176,
        5216
      ],
      "webhookId": "51f38ce6-1227-4b0d-a156-19820f94da6d",
      "credentials": {
        "slackOAuth2Api": {
          "id": "TtgEhzUDH0MsxlGp",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "triggerAtDay": [
                2,
                5
              ],
              "triggerAtHour": 10
            }
          ]
        }
      },
      "id": "96aaa2a6-1bd3-4959-9fcd-cb93644eba55",
      "name": "Tue&Fri 10am",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -10192,
        5216
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "id",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "id-2",
              "name": "title",
              "value": "={{ $json.title?.rendered || $json.title }}",
              "type": "string"
            },
            {
              "id": "id-3",
              "name": "content",
              "value": "={{ $json.content?.rendered || $json.content }}",
              "type": "string"
            },
            {
              "id": "id-4",
              "name": "link",
              "value": "={{ $json.link }}",
              "type": "string"
            },
            {
              "id": "id-5",
              "name": "slug",
              "value": "={{ $json.slug }}",
              "type": "string"
            },
            {
              "id": "id-6",
              "name": "lang",
              "value": "={{ $json.lang }}",
              "type": "string"
            },
            {
              "id": "id-7",
              "name": "seoScore",
              "value": "={{ $json.meta?.rank_math_seo_score || 0 }}",
              "type": "number"
            },
            {
              "id": "id-8",
              "name": "focusKeyword",
              "value": "={{ $json.meta?.rank_math_focus_keyword || '' }}",
              "type": "string"
            },
            {
              "id": "id-9",
              "name": "seoTitle",
              "value": "={{ $json.meta?.rank_math_title || '' }}",
              "type": "string"
            },
            {
              "id": "id-10",
              "name": "seoDescription",
              "value": "={{ $json.meta?.rank_math_description || '' }}",
              "type": "string"
            },
            {
              "id": "0717a186-b373-4cdf-9a97-34faddd87fc5",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "64e94e99-1a33-4a58-976a-8aea99d8ec13",
      "name": "Extract & Pair Posts by Topic",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -9520,
        5216
      ]
    },
    {
      "parameters": {
        "jsCode": "// Group posts by base slug (topic), require BOTH languages, pick worst topic, SKIP recently processed\nconst posts = $input.all().map(i => i.json);\nconst config = $('Configuration').first().json;\nconst scoreThreshold = config.scoreThreshold ?? 80;\nconst skipDays = 30;\n\nconst groupedBySlug = {};\nfor (const post of posts) {\n  // Skip empty/placeholder/stub posts\n  const titleText = (post.title || '').trim();\n  const contentText = (post.content || '').replace(/<[^>]*>/g, '').trim();\n  if (!titleText || contentText.length < 50) {\n    console.log(`â­ï¸ Skipping empty/stub post ID ${post.id}: \"${titleText || '(no title)'}\"`);\n    continue;\n  }\n\n  const processedDate = post.lastProcessed;\n  if (processedDate) {\n    const daysSince = (Date.now() - new Date(processedDate).getTime()) / (1000 * 60 * 60 * 24);\n    if (daysSince < skipDays) {\n      console.log(`â­ï¸ Skipping \"${post.title}\" - processed ${Math.round(daysSince)} days ago`);\n      continue;\n    }\n  }\n\n  const slug = post.slug || '';\n  let baseSlug = slug;\n\n  if (slug.endsWith('-he')) baseSlug = slug.slice(0, -3);\n  else if (slug.endsWith('-en')) baseSlug = slug.slice(0, -3);\n\n  if (!groupedBySlug[baseSlug]) groupedBySlug[baseSlug] = [];\n  groupedBySlug[baseSlug].push(post);\n}\n\nconst candidates = [];\nfor (const [baseSlug, topicPosts] of Object.entries(groupedBySlug)) {\n  const hasHebrew = topicPosts.some(p => p.lang === 'he');\n  const hasEnglish = topicPosts.some(p => p.lang === 'en');\n  if (!hasHebrew || !hasEnglish) continue;\n\n  const scores = topicPosts.map(p => Number(p.seoScore || 0));\n  const lowestScore = Math.min(...scores);\n  if (lowestScore >= scoreThreshold) continue;\n\n  const avg = scores.reduce((s, v) => s + v, 0) / scores.length;\n\n  candidates.push({\n    baseSlug,\n    posts: topicPosts,\n    lowestScore,\n    averageScore: avg\n  });\n}\n\nif (candidates.length === 0) {\n  console.log('âœ… No posts need fixing');\n  return [];\n}\n\ncandidates.sort((a, b) => a.lowestScore - b.lowestScore);\nconst worst = candidates[0];\n\nconsole.log(`ğŸ¯ Selected topic \"${worst.baseSlug}\" with score ${worst.lowestScore}`);\nconsole.log(`ğŸ“ Posts: ${worst.posts.map(p => p.title + ' (' + p.lang + ')').join(', ')}`);\n\nreturn [{\n  json: {\n    baseSlug: worst.baseSlug,\n    posts: worst.posts,\n    topicLowestScore: worst.lowestScore,\n    topicAverageScore: worst.averageScore\n  }\n}];"
      },
      "id": "28ad7c2b-2811-47ef-b30b-227108a08cc3",
      "name": "Group Posts by Topic",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9296,
        5216
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "posts-exists",
              "leftValue": "={{ $json.posts }}",
              "operator": {
                "type": "any",
                "operation": "exists"
              }
            },
            {
              "id": "posts-length-gte-2",
              "leftValue": "={{ $json.posts.length }}",
              "rightValue": 2,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f77a0962-81fc-48aa-a6eb-352ae3522622",
      "name": "Filter: Has Both Languages",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -9072,
        5216
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "posts",
        "include": "selectedOtherFields",
        "fieldsToInclude": "baseSlug",
        "options": {}
      },
      "id": "5afdbc49-3b70-4bc4-a019-10bb0d225187",
      "name": "Split to Individual Posts",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -8848,
        5216
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// Flatten posts object to root level and sort Hebrew first\nconst flattened = items.map(item => {\n  const post = item.json.posts || item.json;\n  return {\n    json: {\n      ...post,\n      baseSlug: item.json.baseSlug || post.baseSlug\n    }\n  };\n});\n\nflattened.sort((a, b) => {\n  const aw = a.json.lang === 'he' ? 0 : 1;\n  const bw = b.json.lang === 'he' ? 0 : 1;\n  return aw - bw;\n});\n\nreturn flattened;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8624,
        5216
      ],
      "id": "086acb09-b2fc-49c3-bdd7-0e0c1d38d435",
      "name": "Sort: Hebrew First"
    }
  ],
  "pinData": {},
  "connections": {
    "Configuration": {
      "main": [
        [
          {
            "node": "HTTP: Fetch All Published Posts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Fetch All Published Posts": {
      "main": [
        [
          {
            "node": "Extract & Pair Posts by Topic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Posts Need Fixing?": {
      "main": [
        [
          {
            "node": "Analyze SEO Issues",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify: All Good",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze SEO Issues": {
      "main": [
        [
          {
            "node": "AI: Enhance Content for SEO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude Sonnet 4": {
      "ai_languageModel": [
        [
          {
            "node": "AI: Enhance Content for SEO",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI: Enhance Content for SEO": {
      "main": [
        [
          {
            "node": "Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response": {
      "main": [
        [
          {
            "node": "Build Gutenberg Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Gutenberg Content": {
      "main": [
        [
          {
            "node": "Format Approval Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Approval Message": {
      "main": [
        [
          {
            "node": "Send Approval Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Approval Request": {
      "main": [
        [
          {
            "node": "Approved?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Approved?": {
      "main": [
        [
          {
            "node": "HTTP: Update WordPress Post",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Request Rejection Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Request Rejection Feedback": {
      "main": [
        [
          {
            "node": "Check Rejection Count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Rejection Count": {
      "main": [
        [
          {
            "node": "Continue Revising?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Continue Revising?": {
      "main": [
        [
          {
            "node": "AI: Revise with Feedback",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse Revision Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI: Revise with Feedback": {
      "main": [
        [
          {
            "node": "Posts Need Fixing?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude Sonnet 4 Revision": {
      "ai_languageModel": [
        [
          {
            "node": "AI: Revise with Feedback",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse Revision Response": {
      "main": [
        [
          {
            "node": "Build Revised Gutenberg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Revised Gutenberg": {
      "main": [
        [
          {
            "node": "Format Revision Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Revision Approval": {
      "main": [
        [
          {
            "node": "Send Revision Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Revision Approval": {
      "main": [
        [
          {
            "node": "Revision Approved?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Revision Approved?": {
      "main": [
        [
          {
            "node": "HTTP: Update Post (Revision)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Request Rejection Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Update Post (Revision)": {
      "main": [
        [
          {
            "node": "Recalculate SEO Score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Update WordPress Post": {
      "main": [
        [
          {
            "node": "Recalculate SEO Score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recalculate SEO Score": {
      "main": [
        [
          {
            "node": "HTTP: Save New Score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Save New Score": {
      "main": [
        [
          {
            "node": "Notify: Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tue&Fri 10am": {
      "main": [
        [
          {
            "node": "Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract & Pair Posts by Topic": {
      "main": [
        [
          {
            "node": "Group Posts by Topic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Group Posts by Topic": {
      "main": [
        [
          {
            "node": "Filter: Has Both Languages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter: Has Both Languages": {
      "main": [
        [
          {
            "node": "Split to Individual Posts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split to Individual Posts": {
      "main": [
        [
          {
            "node": "Sort: Hebrew First",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sort: Hebrew First": {
      "main": [
        [
          {
            "node": "Posts Need Fixing?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": true,
    "binaryMode": "separate"
  },
  "versionId": "1bcbf32b-d33d-4f16-857f-9d3edb0804c5",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "debc7feccc354e86e5a53344362b691cecb5d65ac2ba67b45cdccf9a516514d6"
  },
  "id": "tJ4DO2ru2ILyX5yM",
  "tags": [
    {
      "updatedAt": "2026-01-15T06:51:11.693Z",
      "createdAt": "2026-01-15T06:51:11.693Z",
      "id": "9GHXxWp6cR4uduY6",
      "name": "blog"
    },
    {
      "updatedAt": "2026-01-15T06:50:34.281Z",
      "createdAt": "2026-01-15T06:50:34.281Z",
      "id": "Tq5JEblC9nELmMk3",
      "name": "seo"
    },
    {
      "updatedAt": "2025-10-16T21:55:09.627Z",
      "createdAt": "2025-10-16T21:55:09.627Z",
      "id": "wfcfkpC0G9jkw1Uz",
      "name": "wordpress"
    }
  ]
}